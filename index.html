<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²å ‚ç§©åºå™ªéŸ³åµæ¸¬å™¨</title>
    <style>
        :root {
            --bg-color: #e0f7fa;
            --text-color: #37474f;
            --meter-color: #4caf50;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            transition: background-color 0.3s ease;
            overflow: hidden; /* é˜²æ­¢éœ‡å‹•æ™‚å‡ºç¾å·è»¸ */
        }

        /* ç‹€æ…‹é¡åˆ¥ */
        body.state-quiet { background-color: #e8f5e9; } /* æ·ºç¶  */
        body.state-warn { background-color: #fff3e0; } /* æ·ºæ©˜ */
        body.state-loud { 
            background-color: #ffebee; 
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        } /* æ·ºç´… + éœ‡å‹• */

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        h1 { margin-top: 0; color: #455a64; }

        /* è¡¨æƒ…èˆ‡ç‹€æ…‹é¡¯ç¤º */
        .feedback-area {
            margin: 20px 0;
        }
        
        .emoji {
            font-size: 120px;
            display: block;
            margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .status-text {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        /* éŸ³é‡æ¢ */
        .meter-container {
            width: 100%;
            height: 40px;
            background-color: #eceff1;
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .meter-bar {
            height: 100%;
            width: 0%;
            background-color: #4caf50;
            border-radius: 20px;
            transition: width 0.1s linear, background-color 0.2s;
        }

        .threshold-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #ff5252;
            left: 70%; /* é è¨­ä½ç½® */
            z-index: 2;
            opacity: 0.7;
        }
        
        .threshold-label {
            position: absolute;
            top: -25px;
            left: 70%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #ff5252;
            font-weight: bold;
        }

        /* éŠæˆ²åŒ–æ•¸æ“š */
        .stats-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 10px;
        }

        .stat-box h3 { margin: 0 0 5px 0; font-size: 1rem; color: #78909c; }
        .stat-box p { margin: 0; font-size: 1.5rem; font-weight: bold; color: #37474f; }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }

        button#startBtn {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(33, 150, 243, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        button#startBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(33, 150, 243, 0.4); }
        button#startBtn:active { transform: translateY(0); }
        
        button#resetBtn {
            background-color: #90a4ae;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            display: none;
        }

        .settings {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .slider-wrapper {
            width: 80%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type=range] { flex-grow: 1; }
        label { white-space: nowrap; font-size: 0.9rem; color: #666; }

    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ˜„ ç­ç´šç§©åºå®ˆè­·è€…</h1>
        
        <div class="feedback-area">
            <span class="emoji" id="emoji">ğŸ˜´</span>
            <span class="status-text" id="statusText" style="color: #9e9e9e;">é»æ“ŠæŒ‰éˆ•é–‹å§‹</span>
        </div>

        <div class="meter-container">
            <div class="meter-bar" id="meterBar"></div>
            <div class="threshold-line" id="thresholdLine"></div>
        </div>

        <div class="stats-container">
            <div class="stat-box">
                <h3>å®‰éœæŒçºŒæ™‚é–“</h3>
                <p id="timer">00:00</p>
            </div>
            <div class="stat-box">
                <h3>æœ€é«˜ç´€éŒ„</h3>
                <p id="bestRecord">00:00</p>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">ğŸ¤ å•Ÿå‹•éº¥å…‹é¢¨</button>
            <button id="resetBtn">é‡ç½®ç´€éŒ„</button>

            <div class="settings" id="settingsPanel" style="display:none;">
                <div class="slider-wrapper">
                    <label>éˆæ•åº¦ (éº¥å…‹é¢¨å¢ç›Š)</label>
                    <input type="range" id="sensitivity" min="1" max="300" value="150">
                </div>
                <div class="slider-wrapper">
                    <label>åµé¬§é–€æª» (ç´…ç·š)</label>
                    <input type="range" id="threshold" min="10" max="90" value="70">
                </div>
            </div>
        </div>
    </div>

    <script>
        // è®Šæ•¸å®£å‘Š
        let audioContext, analyser, microphone, javascriptNode;
        let isRunning = false;
        
        // çµ±è¨ˆç›¸é—œ
        let quietSeconds = 0;
        let bestSeconds = 0;
        let timerInterval = null;
        let isTooLoud = false;
        let warningCounter = 0; // ç·©è¡è¨ˆæ•¸å™¨ï¼Œé¿å…ç¬é–“è²éŸ³é€ æˆèª¤åˆ¤

        // DOM å…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const meterBar = document.getElementById('meterBar');
        const thresholdLine = document.getElementById('thresholdLine');
        const emoji = document.getElementById('emoji');
        const statusText = document.getElementById('statusText');
        const timerDisplay = document.getElementById('timer');
        const bestDisplay = document.getElementById('bestRecord');
        const sensitivityInput = document.getElementById('sensitivity');
        const thresholdInput = document.getElementById('threshold');
        const body = document.body;

        // æ›´æ–°ç´…ç·šä½ç½®
        thresholdInput.addEventListener('input', (e) => {
            thresholdLine.style.left = e.target.value + '%';
        });

        // æ ¼å¼åŒ–æ™‚é–“ MM:SS
        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        // è¨ˆæ™‚å™¨é‚è¼¯
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isTooLoud && isRunning) {
                    quietSeconds++;
                    timerDisplay.textContent = formatTime(quietSeconds);
                    
                    if (quietSeconds > bestSeconds) {
                        bestSeconds = quietSeconds;
                        bestDisplay.textContent = formatTime(bestSeconds);
                        bestDisplay.style.color = '#ff9800'; // ç ´ç´€éŒ„äº®è‰²
                    }
                }
            }, 1000);
        }

        function resetTimer() {
            quietSeconds = 0;
            timerDisplay.textContent = "00:00";
            timerDisplay.style.color = "#37474f";
            bestDisplay.style.color = "#37474f";
        }

        // è¦–è¦ºæ›´æ–°ä¸»é‚è¼¯
        function updateUI(volume) {
            const threshold = parseInt(thresholdInput.value); // 0-100
            
            // è¨­å®šé•·æ¢åœ–å¯¬åº¦
            meterBar.style.width = volume + '%';

            // ç‹€æ…‹åˆ¤æ–·
            if (volume > threshold) {
                // å¤ªåµäº†
                warningCounter++;
                if (warningCounter > 2) { // é€£çºŒåµæ¸¬åˆ°å¹¾æ¬¡æ‰è§¸ç™¼ï¼Œé¿å…ç¬é–“é›œéŸ³
                    isTooLoud = true;
                    body.className = 'state-loud';
                    emoji.textContent = 'ğŸ¤¬'; // æˆ– ğŸ˜±
                    statusText.textContent = 'å¤ªåµäº†ï¼å®‰éœï¼';
                    statusText.style.color = '#d32f2f';
                    meterBar.style.backgroundColor = '#f44336';
                    
                    // é‡ç½®ç•¶å‰è¨ˆæ™‚ï¼Œä½†ä¸é‡ç½®æœ€é«˜ç´€éŒ„
                    quietSeconds = 0; 
                    timerDisplay.textContent = "00:00";
                    timerDisplay.style.color = "#d32f2f"; // è­¦å‘Šè‰²
                }
            } else if (volume > threshold * 0.7) {
                // è­¦å‘Šå€ (é»ƒè‰²)
                warningCounter = 0;
                isTooLoud = false;
                body.className = 'state-warn';
                emoji.textContent = 'ğŸ¤«';
                statusText.textContent = 'æ³¨æ„éŸ³é‡...';
                statusText.style.color = '#ff9800';
                meterBar.style.backgroundColor = '#ff9800';
                timerDisplay.style.color = "#37474f";
            } else {
                // å®‰éœå€ (ç¶ è‰²)
                warningCounter = 0;
                isTooLoud = false;
                body.className = 'state-quiet';
                emoji.textContent = 'ğŸ˜Š';
                statusText.textContent = 'å¾ˆæ£’ï¼Œä¿æŒå®‰éœ';
                statusText.style.color = '#2e7d32';
                meterBar.style.backgroundColor = '#4caf50';
                timerDisplay.style.color = "#37474f";
            }
        }

        // å•Ÿå‹•éŸ³è¨Šè™•ç†
        async function startMonitoring() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    
                    let values = 0;
                    const length = array.length;
                    for (let i = 0; i < length; i++) {
                        values += array[i];
                    }

                    // è¨ˆç®—å¹³å‡éŸ³é‡ä¸¦æ¨™æº–åŒ–
                    const average = values / length;
                    
                    // æ ¹æ“šéˆæ•åº¦èª¿æ•´æ•¸å€¼
                    const sensitivity = parseInt(sensitivityInput.value) / 100;
                    let finalVolume = average * sensitivity; // æ”¾å¤§è¨Šè™Ÿ
                    
                    // é™åˆ¶åœ¨ 0-100 ä¹‹é–“
                    finalVolume = Math.min(100, Math.max(0, finalVolume));
                    
                    updateUI(finalVolume);
                };

                // æ›´æ–°ä»‹é¢ç‹€æ…‹
                isRunning = true;
                startBtn.style.display = 'none';
                resetBtn.style.display = 'inline-block';
                settingsPanel.style.display = 'flex';
                startTimer();

            } catch (err) {
                console.error(err);
                alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ã€‚è«‹ç¢ºèªï¼š\n1. æ‚¨å·²æŒ‰ä¸‹ã€Œå…è¨±ã€ä½¿ç”¨éº¥å…‹é¢¨ã€‚\n2. è‹¥åœ¨é›»è…¦ä¸ŠåŸ·è¡Œï¼Œè«‹ç¢ºèªç¶²é ç¶²å€æ˜¯ https é–‹é ­æˆ– localhost (ç€è¦½å™¨å®‰å…¨é™åˆ¶)ã€‚');
            }
        }

        // äº‹ä»¶ç›£è½
        startBtn.addEventListener('click', startMonitoring);
        
        resetBtn.addEventListener('click', () => {
            resetTimer();
            bestSeconds = 0;
            bestDisplay.textContent = "00:00";
            bestDisplay.style.color = "#37474f";
        });

    </script>
</body>
</html>